/// <reference path="../typings/chai/chai.d.ts"/>
/// <reference path="../typings/mocha/mocha.d.ts"/>
/// <reference path="../typings/node/node.d.ts"/>
var chai = require('chai');
var fs = require('fs');
var main = require('../lib/main');
var ts = require('typescript');
function expectTranslate(tsCode, options) {
    if (options === void 0) { options = {}; }
    var result = translateSource(tsCode, options);
    return chai.expect(result);
}
exports.expectTranslate = expectTranslate;
function expectErroneousCode(tsCode, options) {
    if (options === void 0) { options = {}; }
    options.failFast = false; // Collect *all* errors.
    return chai.expect(function () { return translateSource(tsCode, options); });
}
exports.expectErroneousCode = expectErroneousCode;
var compilerOptions = main.COMPILER_OPTIONS;
var defaultLibName = ts.getDefaultLibFileName(compilerOptions);
var libSource = fs.readFileSync(ts.getDefaultLibFilePath(compilerOptions), 'utf-8');
var libSourceFile;
function parseFiles(nameToContent) {
    var result;
    var compilerHost = {
        getSourceFile: function (sourceName, languageVersion) {
            if (nameToContent.hasOwnProperty(sourceName)) {
                return ts.createSourceFile(sourceName, nameToContent[sourceName], compilerOptions.target, true);
            }
            if (sourceName === defaultLibName) {
                if (!libSourceFile) {
                    // Cache to avoid excessive test times.
                    libSourceFile = ts.createSourceFile(sourceName, libSource, compilerOptions.target, true);
                }
                return libSourceFile;
            }
            return undefined;
        },
        writeFile: function (name, text, writeByteOrderMark) { result = text; },
        getDefaultLibFileName: function () { return defaultLibName; },
        useCaseSensitiveFileNames: function () { return false; },
        getCanonicalFileName: function (filename) { return filename; },
        getCurrentDirectory: function () { return ''; },
        getNewLine: function () { return '\n'; }
    };
    // Create a program from inputs
    var entryPoints = Object.keys(nameToContent);
    var program = ts.createProgram(entryPoints, compilerOptions, compilerHost);
    if (program.getSyntacticDiagnostics().length > 0) {
        // Throw first error.
        var first = program.getSyntacticDiagnostics()[0];
        throw new Error(first.start + ": " + first.messageText + " in " + nameToContent[entryPoints[0]]);
    }
    return program;
}
exports.parseFiles = parseFiles;
function translateSources(contents, options) {
    if (options === void 0) { options = {}; }
    // Default to quick stack traces.
    if (!options.hasOwnProperty('failFast'))
        options.failFast = true;
    var namesToContent;
    if (typeof contents === 'string') {
        namesToContent = {};
        namesToContent['main.ts'] = contents;
    }
    else {
        namesToContent = contents;
    }
    var transpiler = new main.Transpiler(options);
    var program = parseFiles(namesToContent);
    return transpiler.translateProgram(program);
}
exports.translateSources = translateSources;
function translateSource(contents, options) {
    if (options === void 0) { options = {}; }
    var results = translateSources(contents, options);
    // Return the main outcome, from 'main.ts'.
    return results['main.ts'];
}
exports.translateSource = translateSource;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdGVzdF9zdXBwb3J0LnRzIl0sIm5hbWVzIjpbImV4cGVjdFRyYW5zbGF0ZSIsImV4cGVjdEVycm9uZW91c0NvZGUiLCJwYXJzZUZpbGVzIiwidHJhbnNsYXRlU291cmNlcyIsInRyYW5zbGF0ZVNvdXJjZSJdLCJtYXBwaW5ncyI6IkFBQUEsaURBQWlEO0FBQ2pELG1EQUFtRDtBQUNuRCxpREFBaUQ7QUFDakQsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFDOUIsSUFBTyxFQUFFLFdBQVcsSUFBSSxDQUFDLENBQUM7QUFDMUIsSUFBTyxJQUFJLFdBQVcsYUFBYSxDQUFDLENBQUM7QUFFckMsSUFBTyxFQUFFLFdBQVcsWUFBWSxDQUFDLENBQUM7QUFLbEMseUJBQWdDLE1BQWEsRUFBRSxPQUFvQztJQUFwQ0EsdUJBQW9DQSxHQUFwQ0EsWUFBb0NBO0lBQ2pGQSxJQUFJQSxNQUFNQSxHQUFHQSxlQUFlQSxDQUFDQSxNQUFNQSxFQUFFQSxPQUFPQSxDQUFDQSxDQUFDQTtJQUM5Q0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7QUFDN0JBLENBQUNBO0FBSGUsdUJBQWUsa0JBRzlCLENBQUE7QUFFRCw2QkFBb0MsTUFBYSxFQUFFLE9BQW9DO0lBQXBDQyx1QkFBb0NBLEdBQXBDQSxZQUFvQ0E7SUFDckZBLE9BQU9BLENBQUNBLFFBQVFBLEdBQUdBLEtBQUtBLEVBQUdBLHdCQUF3QkE7SUFDbkRBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLGNBQU1BLE9BQUFBLGVBQWVBLENBQUNBLE1BQU1BLEVBQUVBLE9BQU9BLENBQUNBLEVBQWhDQSxDQUFnQ0EsQ0FBQ0EsQ0FBQ0E7QUFDN0RBLENBQUNBO0FBSGUsMkJBQW1CLHNCQUdsQyxDQUFBO0FBRUQsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO0FBQzVDLElBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQyxx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O1FBQUNBLE9BQU9BLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBO0lBQ2pFQSxJQUFJQSxjQUF5QkEsQ0FBQ0E7SUFDOUJBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLFFBQVFBLEtBQUtBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1FBQ2pDQSxjQUFjQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUNwQkEsY0FBY0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsR0FBR0EsUUFBUUEsQ0FBQ0E7SUFDdkNBLENBQUNBO0lBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ05BLGNBQWNBLEdBQUdBLFFBQVFBLENBQUNBO0lBQzVCQSxDQUFDQTtJQUNEQSxJQUFJQSxVQUFVQSxHQUFHQSxJQUFJQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtJQUM5Q0EsSUFBSUEsT0FBT0EsR0FBR0EsVUFBVUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7SUFDekNBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7QUFDOUNBLENBQUNBO0FBYmUsd0JBQWdCLG1CQWEvQixDQUFBO0FBR0QseUJBQWdDLFFBQWUsRUFBRSxPQUFvQztJQUFwQ0MsdUJBQW9DQSxHQUFwQ0EsWUFBb0NBO0lBQ25GQSxJQUFJQSxPQUFPQSxHQUFHQSxnQkFBZ0JBLENBQUNBLFFBQVFBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO0lBQ2xEQSwyQ0FBMkNBO0lBQzNDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtBQUM1QkEsQ0FBQ0E7QUFKZSx1QkFBZSxrQkFJOUIsQ0FBQSIsImZpbGUiOiJ0ZXN0L3Rlc3Rfc3VwcG9ydC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL2NoYWkvY2hhaS5kLnRzXCIvPlxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL3R5cGluZ3MvbW9jaGEvbW9jaGEuZC50c1wiLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL25vZGUvbm9kZS5kLnRzXCIvPlxuaW1wb3J0IGNoYWkgPSByZXF1aXJlKCdjaGFpJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IG1haW4gPSByZXF1aXJlKCcuLi9saWIvbWFpbicpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgdHMgPSByZXF1aXJlKCd0eXBlc2NyaXB0Jyk7XG5cbmV4cG9ydCB0eXBlIFN0cmluZ01hcCA9IHsgW2s6IHN0cmluZ106IHN0cmluZyB9O1xuZXhwb3J0IHR5cGUgSW5wdXQgPSBzdHJpbmcgfCBTdHJpbmdNYXA7XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBlY3RUcmFuc2xhdGUodHNDb2RlOiBJbnB1dCwgb3B0aW9uczogbWFpbi5UcmFuc3BpbGVyT3B0aW9ucyA9IHt9KSB7XG4gIHZhciByZXN1bHQgPSB0cmFuc2xhdGVTb3VyY2UodHNDb2RlLCBvcHRpb25zKTtcbiAgcmV0dXJuIGNoYWkuZXhwZWN0KHJlc3VsdCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBlY3RFcnJvbmVvdXNDb2RlKHRzQ29kZTogSW5wdXQsIG9wdGlvbnM6IG1haW4uVHJhbnNwaWxlck9wdGlvbnMgPSB7fSkge1xuICBvcHRpb25zLmZhaWxGYXN0ID0gZmFsc2U7ICAvLyBDb2xsZWN0ICphbGwqIGVycm9ycy5cbiAgcmV0dXJuIGNoYWkuZXhwZWN0KCgpID0+IHRyYW5zbGF0ZVNvdXJjZSh0c0NvZGUsIG9wdGlvbnMpKTtcbn1cblxudmFyIGNvbXBpbGVyT3B0aW9ucyA9IG1haW4uQ09NUElMRVJfT1BUSU9OUztcbnZhciBkZWZhdWx0TGliTmFtZSA9IHRzLmdldERlZmF1bHRMaWJGaWxlTmFtZShjb21waWxlck9wdGlvbnMpO1xudmFyIGxpYlNvdXJjZSA9IGZzLnJlYWRGaWxlU3luYyh0cy5nZXREZWZhdWx0TGliRmlsZVBhdGgoY29tcGlsZXJPcHRpb25zKSwgJ3V0Zi04Jyk7XG52YXIgbGliU291cmNlRmlsZTogdHMuU291cmNlRmlsZTtcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlRmlsZXMobmFtZVRvQ29udGVudDogU3RyaW5nTWFwKTogdHMuUHJvZ3JhbSB7XG4gIHZhciByZXN1bHQ6IHN0cmluZztcbiAgdmFyIGNvbXBpbGVySG9zdDogdHMuQ29tcGlsZXJIb3N0ID0ge1xuICAgIGdldFNvdXJjZUZpbGU6IGZ1bmN0aW9uKHNvdXJjZU5hbWUsIGxhbmd1YWdlVmVyc2lvbikge1xuICAgICAgaWYgKG5hbWVUb0NvbnRlbnQuaGFzT3duUHJvcGVydHkoc291cmNlTmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIHRzLmNyZWF0ZVNvdXJjZUZpbGUoc291cmNlTmFtZSwgbmFtZVRvQ29udGVudFtzb3VyY2VOYW1lXSwgY29tcGlsZXJPcHRpb25zLnRhcmdldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSk7XG4gICAgICB9XG4gICAgICBpZiAoc291cmNlTmFtZSA9PT0gZGVmYXVsdExpYk5hbWUpIHtcbiAgICAgICAgaWYgKCFsaWJTb3VyY2VGaWxlKSB7XG4gICAgICAgICAgLy8gQ2FjaGUgdG8gYXZvaWQgZXhjZXNzaXZlIHRlc3QgdGltZXMuXG4gICAgICAgICAgbGliU291cmNlRmlsZSA9IHRzLmNyZWF0ZVNvdXJjZUZpbGUoc291cmNlTmFtZSwgbGliU291cmNlLCBjb21waWxlck9wdGlvbnMudGFyZ2V0LCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGliU291cmNlRmlsZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfSxcbiAgICB3cml0ZUZpbGU6IGZ1bmN0aW9uKG5hbWUsIHRleHQsIHdyaXRlQnl0ZU9yZGVyTWFyaykgeyByZXN1bHQgPSB0ZXh0OyB9LFxuICAgIGdldERlZmF1bHRMaWJGaWxlTmFtZTogKCkgPT4gZGVmYXVsdExpYk5hbWUsXG4gICAgdXNlQ2FzZVNlbnNpdGl2ZUZpbGVOYW1lczogKCkgPT4gZmFsc2UsXG4gICAgZ2V0Q2Fub25pY2FsRmlsZU5hbWU6IChmaWxlbmFtZSkgPT4gZmlsZW5hbWUsXG4gICAgZ2V0Q3VycmVudERpcmVjdG9yeTogKCkgPT4gJycsXG4gICAgZ2V0TmV3TGluZTogKCkgPT4gJ1xcbidcbiAgfTtcbiAgLy8gQ3JlYXRlIGEgcHJvZ3JhbSBmcm9tIGlucHV0c1xuICB2YXIgZW50cnlQb2ludHMgPSBPYmplY3Qua2V5cyhuYW1lVG9Db250ZW50KTtcbiAgdmFyIHByb2dyYW06IHRzLlByb2dyYW0gPSB0cy5jcmVhdGVQcm9ncmFtKGVudHJ5UG9pbnRzLCBjb21waWxlck9wdGlvbnMsIGNvbXBpbGVySG9zdCk7XG4gIGlmIChwcm9ncmFtLmdldFN5bnRhY3RpY0RpYWdub3N0aWNzKCkubGVuZ3RoID4gMCkge1xuICAgIC8vIFRocm93IGZpcnN0IGVycm9yLlxuICAgIHZhciBmaXJzdCA9IHByb2dyYW0uZ2V0U3ludGFjdGljRGlhZ25vc3RpY3MoKVswXTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7Zmlyc3Quc3RhcnR9OiAke2ZpcnN0Lm1lc3NhZ2VUZXh0fSBpbiAke25hbWVUb0NvbnRlbnRbZW50cnlQb2ludHNbMF1dfWApO1xuICB9XG4gIHJldHVybiBwcm9ncmFtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNsYXRlU291cmNlcyhjb250ZW50czogSW5wdXQsIG9wdGlvbnM6IG1haW4uVHJhbnNwaWxlck9wdGlvbnMgPSB7fSk6IFN0cmluZ01hcCB7XG4gIC8vIERlZmF1bHQgdG8gcXVpY2sgc3RhY2sgdHJhY2VzLlxuICBpZiAoIW9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ2ZhaWxGYXN0JykpIG9wdGlvbnMuZmFpbEZhc3QgPSB0cnVlO1xuICB2YXIgbmFtZXNUb0NvbnRlbnQ6IFN0cmluZ01hcDtcbiAgaWYgKHR5cGVvZiBjb250ZW50cyA9PT0gJ3N0cmluZycpIHtcbiAgICBuYW1lc1RvQ29udGVudCA9IHt9O1xuICAgIG5hbWVzVG9Db250ZW50WydtYWluLnRzJ10gPSBjb250ZW50cztcbiAgfSBlbHNlIHtcbiAgICBuYW1lc1RvQ29udGVudCA9IGNvbnRlbnRzO1xuICB9XG4gIHZhciB0cmFuc3BpbGVyID0gbmV3IG1haW4uVHJhbnNwaWxlcihvcHRpb25zKTtcbiAgdmFyIHByb2dyYW0gPSBwYXJzZUZpbGVzKG5hbWVzVG9Db250ZW50KTtcbiAgcmV0dXJuIHRyYW5zcGlsZXIudHJhbnNsYXRlUHJvZ3JhbShwcm9ncmFtKTtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gdHJhbnNsYXRlU291cmNlKGNvbnRlbnRzOiBJbnB1dCwgb3B0aW9uczogbWFpbi5UcmFuc3BpbGVyT3B0aW9ucyA9IHt9KTogc3RyaW5nIHtcbiAgdmFyIHJlc3VsdHMgPSB0cmFuc2xhdGVTb3VyY2VzKGNvbnRlbnRzLCBvcHRpb25zKTtcbiAgLy8gUmV0dXJuIHRoZSBtYWluIG91dGNvbWUsIGZyb20gJ21haW4udHMnLlxuICByZXR1cm4gcmVzdWx0c1snbWFpbi50cyddO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9